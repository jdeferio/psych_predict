import io
import SQL_Connect

def main():
        cursor = SQL_Connect.connect_DB()

        output_file = 'cdrn_psych_hosp_2014_B.csv'

# Selects all patients in the cohort and reports their gender, birth date, and age at '2014-01-01'
        sql = "select v.person_id, v.visit_start_date, v.visit_concept_id from staging.condition_occurrence as co join staging.visit_occurrence as v on co.visit_occurrence_id = v.visit_occurrence_id where (v.visit_concept_id = 9201) and ((co.condition_source_value like 'ICD9CM:295%') or (co.condition_source_value like 'ICD9CM:296%') or (co.condition_source_value like 'ICD9CM:297%') or (co.condition_source_value like 'ICD9CM:298%') or (co.condition_source_value like 'ICD9CM:300%') or (co.condition_source_value like 'ICD9CM:301%') or (co.condition_source_value like 'ICD9CM:302%') or (co.condition_source_value like 'ICD9CM:306%') or (co.condition_source_value like 'ICD9CM:307%') or (co.condition_source_value like 'ICD9CM:308%') or (co.condition_source_value like 'ICD9CM:309%') or (co.condition_source_value like 'ICD9CM:311%') or (co.condition_source_value like 'ICD9CM:312%') or (co.condition_source_value like 'ICD9CM:313%') or (co.condition_source_value like 'ICD9CM:314%') or (co.condition_source_value like 'ICD10CM:F32%') or (co.condition_source_value like 'ICD10CM:F33%') or (co.condition_source_value like 'ICD10CM:F34.1%') or (co.condition_source_value like 'ICD10CM:F20%') or (co.condition_source_value like 'ICD10CM:F30%') or (co.condition_source_value like 'ICD10CM:F31%') or (co.condition_source_value like 'ICD10CM:F39%') or (co.condition_source_value like 'ICD10CM:F34.81') or (co.condition_source_value like 'ICD10CM:F34.89') or (co.condition_source_value like 'ICD10CM:F22%') or (co.condition_source_value like 'ICD10CM:F23%') or (co.condition_source_value like 'ICD10CM:F24%') or (co.condition_source_value like 'ICD10CM:F28%') or (co.condition_source_value like 'ICD10CM:F44.89') or (co.condition_source_value like 'ICD10CM:F23%') or (co.condition_source_value like 'ICD10CM:F29%') or (co.condition_source_value like 'ICD10CM:F4%') or (co.condition_source_value like 'ICD10CM:F60%') or (co.condition_source_value like 'ICD10CM:F21%') or (co.condition_source_value like 'ICD10CM:F68.12') or (co.condition_source_value like 'ICD10CM:F66%') or (co.condition_source_value like 'ICD10CM:F64.1') or (co.condition_source_value like 'ICD10CM:F64.2') or (co.condition_source_value like 'ICD10CM:F64.8') or (co.condition_source_value like 'ICD10CM:F64.9') or (co.condition_source_value like 'ICD10CM:F65%') or (co.condition_source_value like 'ICD10CM:R37%') or (co.condition_source_value like 'ICD10CM:F52%') or (co.condition_source_value like 'ICD10CM:F45.8%') or (co.condition_source_value like 'ICD10CM:F42.4%') or (co.condition_source_value like 'ICD10CM:F52.5%') or (co.condition_source_value like 'ICD10CM:F59%') or (co.condition_source_value like 'ICD10CM:F45.9%') or (co.condition_source_value like 'ICD10CM:F50.00') or (co.condition_source_value like 'ICD10CM:F98.5') or (co.condition_source_value like 'ICD10CM:F95%') or (co.condition_source_value like 'ICD10CM:F98.4') or (co.condition_source_value like 'ICD10CM:F51%') or (co.condition_source_value like 'ICD10CM:F50%') or (co.condition_source_value like 'ICD10CM:F98.0') or (co.condition_source_value like 'ICD10CM:F98.1') or (co.condition_source_value like 'ICD10CM:G44.209') or (co.condition_source_value like 'ICD10CM:F63.3') or (co.condition_source_value like 'ICD10CM:F93.0') or (co.condition_source_value like 'ICD10CM:F94.8') or (co.condition_source_value like 'ICD10CM:F91%') or (co.condition_source_value like 'ICD10CM:F63%') or (co.condition_source_value like 'ICD10CM:F93.8') or (co.condition_source_value like 'ICD10CM:F94.0') or (co.condition_source_value like 'ICD10CM:F94.1') or (co.condition_source_value like 'ICD10CM:F98.8') or (co.condition_source_value like 'ICD10CM:F93.9') or (co.condition_source_value like 'ICD10CM:F94.8') or (co.condition_source_value like 'ICD10CM:F98.9') or (co.condition_source_value like 'ICD10CM:F90%')) and co.condition_type_concept_id in(44786627, 44786629) and (v.visit_start_date between '2014-01-01' and '2014-12-31') and v.person_id in(select distinct person_id from staging.visit_occurrence where (visit_start_date between '2012-01-01' and '2012-12-31') and person_id in(select distinct person_id from staging.visit_occurrence where (visit_start_date between '2013-01-01' and '2013-12-31') and person_id in(select distinct person_id from staging.visit_occurrence where (visit_start_date between '2014-01-01' and '2014-12-31') group by person_id having count(*) >=1) group by person_id having count(*) >=1 ) group by person_id having count(*) >=1) union select v.person_id, v.visit_start_date, v.visit_concept_id from mdd_control.condition_occurrence as co join mdd_control.visit_occurrence as v on co.visit_occurrence_id = v.visit_occurrence_id where (v.visit_concept_id = 9201) and ((co.condition_source_value like 'ICD9CM:295%') or (co.condition_source_value like 'ICD9CM:296%') or (co.condition_source_value like 'ICD9CM:297%') or (co.condition_source_value like 'ICD9CM:298%') or (co.condition_source_value like 'ICD9CM:300%') or (co.condition_source_value like 'ICD9CM:301%') or (co.condition_source_value like 'ICD9CM:302%') or (co.condition_source_value like 'ICD9CM:306%') or (co.condition_source_value like 'ICD9CM:307%') or (co.condition_source_value like 'ICD9CM:308%') or (co.condition_source_value like 'ICD9CM:309%') or (co.condition_source_value like 'ICD9CM:311%') or (co.condition_source_value like 'ICD9CM:312%') or (co.condition_source_value like 'ICD9CM:313%') or (co.condition_source_value like 'ICD9CM:314%') or (co.condition_source_value like 'ICD10CM:F32%') or (co.condition_source_value like 'ICD10CM:F33%') or (co.condition_source_value like 'ICD10CM:F34.1%') or (co.condition_source_value like 'ICD10CM:F20%') or (co.condition_source_value like 'ICD10CM:F30%') or (co.condition_source_value like 'ICD10CM:F31%') or (co.condition_source_value like 'ICD10CM:F39%') or (co.condition_source_value like 'ICD10CM:F34.81') or (co.condition_source_value like 'ICD10CM:F34.89') or (co.condition_source_value like 'ICD10CM:F22%') or (co.condition_source_value like 'ICD10CM:F23%') or (co.condition_source_value like 'ICD10CM:F24%') or (co.condition_source_value like 'ICD10CM:F28%') or (co.condition_source_value like 'ICD10CM:F44.89') or (co.condition_source_value like 'ICD10CM:F23%') or (co.condition_source_value like 'ICD10CM:F29%') or (co.condition_source_value like 'ICD10CM:F4%') or (co.condition_source_value like 'ICD10CM:F60%') or (co.condition_source_value like 'ICD10CM:F21%') or (co.condition_source_value like 'ICD10CM:F68.12') or (co.condition_source_value like 'ICD10CM:F66%') or (co.condition_source_value like 'ICD10CM:F64.1') or (co.condition_source_value like 'ICD10CM:F64.2') or (co.condition_source_value like 'ICD10CM:F64.8') or (co.condition_source_value like 'ICD10CM:F64.9') or (co.condition_source_value like 'ICD10CM:F65%') or (co.condition_source_value like 'ICD10CM:R37%') or (co.condition_source_value like 'ICD10CM:F52%') or (co.condition_source_value like 'ICD10CM:F45.8%') or (co.condition_source_value like 'ICD10CM:F42.4%') or (co.condition_source_value like 'ICD10CM:F52.5%') or (co.condition_source_value like 'ICD10CM:F59%') or (co.condition_source_value like 'ICD10CM:F45.9%') or (co.condition_source_value like 'ICD10CM:F50.00') or (co.condition_source_value like 'ICD10CM:F98.5') or (co.condition_source_value like 'ICD10CM:F95%') or (co.condition_source_value like 'ICD10CM:F98.4') or (co.condition_source_value like 'ICD10CM:F51%') or (co.condition_source_value like 'ICD10CM:F50%') or (co.condition_source_value like 'ICD10CM:F98.0') or (co.condition_source_value like 'ICD10CM:F98.1') or (co.condition_source_value like 'ICD10CM:G44.209') or (co.condition_source_value like 'ICD10CM:F63.3') or (co.condition_source_value like 'ICD10CM:F93.0') or (co.condition_source_value like 'ICD10CM:F94.8') or (co.condition_source_value like 'ICD10CM:F91%') or (co.condition_source_value like 'ICD10CM:F63%') or (co.condition_source_value like 'ICD10CM:F93.8') or (co.condition_source_value like 'ICD10CM:F94.0') or (co.condition_source_value like 'ICD10CM:F94.1') or (co.condition_source_value like 'ICD10CM:F98.8') or (co.condition_source_value like 'ICD10CM:F93.9') or (co.condition_source_value like 'ICD10CM:F94.8') or (co.condition_source_value like 'ICD10CM:F98.9') or (co.condition_source_value like 'ICD10CM:F90%')) and co.condition_type_concept_id in(44786627, 44786629) and (v.visit_start_date between '2014-01-01' and '2014-12-31') and v.person_id in(select distinct person_id from mdd_control.visit_occurrence where (visit_start_date between '2012-01-01' and '2012-12-31') and person_id in(select distinct person_id from mdd_control.visit_occurrence where (visit_start_date between '2013-01-01' and '2013-12-31') and person_id in(select distinct person_id from mdd_control.visit_occurrence where (visit_start_date between '2014-01-01' and '2014-12-31') group by person_id having count(*) >=1) group by person_id having count(*) >=1 ) group by person_id having count(*) >=1)"

        cursor.execute(sql)

        with io.open(output_file, 'w', encoding='utf-8') as f:
            for index, row in enumerate(cursor):
                print(index)
                person_id = str(row[0])
                visit_start_date = str(row[1])
                visit_concept_id = str(row[2])

                line = ','.join([
                    person_id, visit_start_date, visit_concept_id])

                f.write(line + '\n')

        print("Finished Reading!")

if __name__=='__main__':
    main()